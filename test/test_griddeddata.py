# mypy: disable-error-code="list-item"

from pathlib import Path

from dimes.griddeddata import AxisConstraint, DataSelection, GridAxis, GridPointData, RegularGridData

TESTING_DIRECTORY = Path("test_outputs")
TESTING_DIRECTORY.mkdir(exist_ok=True)


def test_2d_data():
    raw_data: dict[str, dict[str, list[float]]] = {
        "grid_variables": {
            "evaporator_liquid_volumetric_flow_rate": [0.01130153653374901],
            "evaporator_liquid_leaving_temperature": [
                275.37222222222226,
                281.66851851851857,
                287.9648148148148,
                294.2611111111111,
            ],
            "condenser_air_entering_drybulb_temperature": [
                285.9277777777778,
                299.0018518518519,
                312.0759259259259,
                325.15,
            ],
            "condenser_air_entering_relative_humidity": [0.4],
            "ambient_pressure": [101325.0],
            "compressor_sequence_number": [1, 2, 3, 4],
        },
        "lookup_variables": {
            "input_power": [
                14192.028626134423,
                30288.393534851617,
                48922.20053440033,
                65032.20311497696,
                16856.289431591576,
                35974.415024870745,
                58106.33515208956,
                77240.65860897877,
                19149.180575493207,
                40867.86550531729,
                66010.29894053208,
                87747.38506217627,
                18344.260557240694,
                39150.018471665106,
                63235.610445711296,
                84058.9960730282,
                15381.031078284199,
                32825.94296723499,
                53020.88282516518,
                70480.57494464055,
                17658.41569382291,
                37686.299670478285,
                60871.393121499736,
                80916.245756064,
                20281.478842038327,
                43284.39779956551,
                69913.51280233801,
                92935.92102109472,
                20576.396799136353,
                43913.80684180984,
                70930.14233560827,
                94287.32503763784,
                16656.72386245575,
                35548.50547710802,
                57418.4006044488,
                76326.1883123999,
                18066.344374212793,
                38556.89433536284,
                62277.58875649283,
                82785.4993700743,
                19968.559581597503,
                42616.570672482834,
                68834.82988718578,
                91502.02954302214,
                19742.163537620225,
                42133.39996762038,
                68054.4063864006,
                90464.61382859459,
                18387.225782414353,
                39241.71414693853,
                63383.718472923174,
                84255.87583729452,
                18577.85299166388,
                39648.54759438295,
                64040.84105940423,
                85129.38784306428,
                18837.859028210736,
                40203.448191318486,
                64937.12359907413,
                86320.81479302813,
                16598.655721869705,
                35424.57740873671,
                57218.230403750444,
                76060.10238398325,
            ],
            "net_evaporator_capacity": [
                60620.9826948891,
                121241.9653897782,
                181862.9480846673,
                242483.9307795564,
                60797.11011089454,
                121594.22022178907,
                182391.3303326836,
                243188.44044357815,
                53353.779037676446,
                106707.55807535289,
                160061.33711302932,
                213415.11615070578,
                38290.98947523472,
                76581.97895046943,
                114872.96842570415,
                153163.95790093887,
                75026.47074115787,
                150052.94148231574,
                225079.4122234736,
                300105.8829646315,
                73861.8457644747,
                147723.6915289494,
                221585.53729342407,
                295447.3830578988,
                65077.76229856798,
                130155.52459713595,
                195233.28689570393,
                260311.0491942719,
                48674.22034343766,
                97348.44068687531,
                146022.66103031297,
                194696.88137375063,
                79838.13123872977,
                159676.26247745953,
                239514.3937161893,
                319352.52495491906,
                77332.753869358,
                154665.507738716,
                231998.261608074,
                309331.015477432,
                67207.9180107627,
                134415.8360215254,
                201623.7540322881,
                268831.6720430508,
                49463.62366294375,
                98927.2473258875,
                148390.87098883124,
                197854.494651775,
                75055.9641876049,
                150111.9283752098,
                225167.8925628147,
                300223.8567504196,
                71209.8344255445,
                142419.668851089,
                213629.5032766335,
                284839.337702178,
                59744.246174260596,
                119488.49234852119,
                179232.7385227818,
                238976.98469704238,
                40659.19943375302,
                81318.39886750604,
                121977.59830125906,
                162636.79773501208,
            ],
            "net_condenser_capacity": [
                74813.01132102351,
                151530.3589246298,
                230785.14861906762,
                307516.1338945334,
                77653.39954248612,
                157568.6352466598,
                240497.66548477317,
                320429.0990525569,
                72502.95961316966,
                147575.42358067018,
                226071.6360535614,
                301162.50121288205,
                56635.25003247541,
                115731.99742213453,
                178108.57887141546,
                237222.95397396706,
                90407.50181944207,
                182878.88444955074,
                278100.29504863877,
                370586.45790927205,
                91520.26145829761,
                185409.9911994277,
                282456.9304149238,
                376363.6288139628,
                85359.2411406063,
                173439.92239670147,
                265146.7996980419,
                353246.97021536663,
                69250.61714257402,
                141262.24752868514,
                216952.80336592125,
                288984.20641138847,
                96494.85510118552,
                195224.76795456756,
                296932.7943206381,
                395678.71326731896,
                95399.0982435708,
                193222.40207407885,
                294275.85036456684,
                392116.5148475063,
                87176.4775923602,
                177032.40669400824,
                270458.58391947387,
                360333.701586073,
                69205.78720056397,
                141060.64729350788,
                216445.27737523185,
                288319.10848036956,
                93443.18997001924,
                189353.64252214832,
                288551.61103573785,
                384479.7325877141,
                89787.68741720838,
                182068.21644547195,
                277670.34433603776,
                369968.72554524225,
                78582.10520247133,
                159691.94053983968,
                244169.86212185593,
                325297.7994900705,
                57257.855155622725,
                116742.97627624276,
                179195.8287050095,
                238696.90011899534,
            ],
            "condenser_air_volumetric_flow_rate": [
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
                7.96462103743574,
                15.92924207487148,
                23.89386311230722,
                31.85848414974296,
            ],
            "oil_cooler_heat": [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            "evaporation_rate": [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            "auxiliary_heat": [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            "operation_state": [
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
                "NORMAL",
            ],
        },
    }

    schema_data: dict[str, dict[str, dict[str, str]]] = {
        "grid_variables": {
            "evaporator_liquid_volumetric_flow_rate": {
                "Units": "m**3/s",
                "Display Name": "Evaporator Liquid Volumetric Flow Rate",
            },
            "evaporator_liquid_leaving_temperature": {
                "Units": "K",
                "Display Name": "Evaporator Liquid Leaving Temperature",
            },
            "condenser_air_entering_drybulb_temperature": {
                "Units": "K",
                "Display Name": "Condenser Air Entering Drybulb Temperature",
            },
            "condenser_air_entering_relative_humidity": {
                "Units": "",
                "Display Name": "Condenser Air Entering Relative Humidity",
            },
            "ambient_pressure": {
                "Units": "Pa",
                "Display Name": "Ambient Pressure",
            },
            "compressor_sequence_number": {
                "Units": "",
                "Display Name": "Compressor Sequence Number",
            },
        },
        "lookup_variables": {
            "input_power": {
                "Units": "W",
                "Display Name": "Input Power",
            },
            "net_evaporator_capacity": {
                "Units": "W",
                "Display Name": "Net Evaporator Capacity",
            },
            "net_condenser_capacity": {
                "Units": "W",
                "Display Name": "Net Condenser Capacity",
            },
            "condenser_air_volumetric_flow_rate": {
                "Units": "m**3/s",
                "Display Name": "Condenser Air Volumetric Flow Rate",
            },
            "oil_cooler_heat": {
                "Units": "W",
                "Display Name": "Oil Cooler Heat",
            },
            "evaporation_rate": {
                "Units": "m**3/s",
                "Display Name": "Evaporation Rate",
            },
            "auxiliary_heat": {
                "Units": "W",
                "Display Name": "Auxiliary Heat",
            },
        },
    }

    grid_axes: list[GridAxis] = []

    for variable_name, values in raw_data["grid_variables"].items():
        schema_info = schema_data["grid_variables"][variable_name]
        grid_axes.append(GridAxis(values, name=schema_info["Display Name"], native_units=schema_info["Units"]))

    grided_data_sets: list[GridPointData] = []

    for variable_name, values in raw_data["lookup_variables"].items():
        if variable_name != "operation_state":
            schema_info = schema_data["lookup_variables"][variable_name]
            y_axis_name = schema_info["Display Name"]
            if "Capacity" in y_axis_name:
                y_axis_name = "Capacity"

            if "Heat" in y_axis_name:
                y_axis_name = "Heat"

            grided_data_sets.append(
                GridPointData(
                    values,
                    name=schema_info["Display Name"],
                    native_units=schema_info["Units"],
                    y_axis_name=y_axis_name,
                )
            )

    cops = []
    eirs = []
    for index in range(len(list(grided_data_sets[0].data_values))):
        cop = (
            raw_data["lookup_variables"]["net_evaporator_capacity"][index]
            / raw_data["lookup_variables"]["input_power"][index]
        )
        eir = 1 / cop
        cops.append(cop)
        eirs.append(eir)

    grided_data_sets.append(GridPointData(cops, name="COP", native_units="", y_axis_name="COP"))
    grided_data_sets.append(GridPointData(eirs, name="Energy Input Ratio", native_units="", y_axis_name="EIR"))

    gridded_data = RegularGridData(grid_axes, grided_data_sets)

    data_selections = {
        "Condenser Air Entering Drybulb Temperature": DataSelection(
            "Condenser Air Entering Drybulb Temperature", "degF", 1
        ),
        "Evaporator Liquid Leaving Temperature": DataSelection("Evaporator Liquid Leaving Temperature", "degF", 1),
        "Evaporator Liquid Volumetric Flow Rate": DataSelection("Evaporator Liquid Volumetric Flow Rate", "gpm", 1),
        "Ambient Pressure": DataSelection("Ambient Pressure", "atm", 1),
        "Condenser Air Entering Relative Humidity": DataSelection("Condenser Air Entering Relative Humidity", "%", 1),
        "Compressor Sequence Number": DataSelection("Compressor Sequence Number", "", 0),
    }

    display_data = [
        DataSelection("Net Evaporator Capacity", "ton_ref"),
        DataSelection("Net Condenser Capacity", "ton_ref"),
        DataSelection("Input Power", "kW"),
        DataSelection("COP", ""),
    ]

    axis_constraints = [
        AxisConstraint(data_selections["Ambient Pressure"]),
        AxisConstraint(data_selections["Condenser Air Entering Relative Humidity"]),
        AxisConstraint(data_selections["Evaporator Liquid Volumetric Flow Rate"]),
    ]

    constrained_grid_axes = [AxisConstraint(data_selections["Compressor Sequence Number"], 4)] + axis_constraints

    plot = gridded_data.make_plot(
        x_grid_axis=data_selections["Condenser Air Entering Drybulb Temperature"],
        display_data=display_data,
        legend_grid_axis=data_selections["Evaporator Liquid Leaving Temperature"],
        constrained_grid_axes=constrained_grid_axes,
    )

    plot.write_html_plot(Path(TESTING_DIRECTORY, "chiller-fTC-fTE.html"))

    plot2 = gridded_data.make_plot(
        x_grid_axis=data_selections["Evaporator Liquid Leaving Temperature"],
        display_data=display_data,
        legend_grid_axis=data_selections["Condenser Air Entering Drybulb Temperature"],
        constrained_grid_axes=constrained_grid_axes,
    )

    plot2.write_html_plot(Path(TESTING_DIRECTORY, "chiller-fTE-fTC.html"))

    constrained_grid_axes = [
        AxisConstraint(data_selections["Evaporator Liquid Leaving Temperature"], 55.0)
    ] + axis_constraints

    plot3 = gridded_data.make_plot(
        x_grid_axis=data_selections["Condenser Air Entering Drybulb Temperature"],
        display_data=display_data,
        legend_grid_axis=data_selections["Compressor Sequence Number"],
        constrained_grid_axes=constrained_grid_axes,
    )

    plot3.write_html_plot(Path(TESTING_DIRECTORY, "chiller-fTE-fSpeed.html"))

    gridded_data.write_to_csv(Path(TESTING_DIRECTORY, "grid-test.csv"))
